
import numpy as np
import matplotlib.pyplot as plt


def main(Gmag, BPmag, RPmag, mini):
    """
    Distance of binary systems to a given isochrone. The plot shows systems
    of different q values, and at different points in the mains sequence.
    """
    isoch = np.array([Gmag, BPmag, RPmag, BPmag - RPmag, mini])
    isoch = interp(isoch)

    q_vals = np.arange(0.2, 1.01, 0.05)
    cmd_plot, cmd_plot_binar, br_dist_all = [], [], []
    for Gmag1 in np.arange(8., 18.01, 2):
        idx = np.argmin(abs(Gmag1 - isoch[0]))
        BP1, RP1 = isoch[1][idx], isoch[2][idx]
        BPRP1 = BP1 - RP1
        mass1 = isoch[4][idx]

        cmd_plot.append([BPRP1, Gmag1])

        br_dist = []
        for q in q_vals:
            mass2 = q * mass1
            idx = np.argmin(abs(mass2 - isoch[4]))
            Gmag2 = isoch[0][idx]
            BP2, RP2 = isoch[1][idx], isoch[2][idx]

            Gcomb = mag_combine(Gmag1, Gmag2)
            BPcomb = mag_combine(BP1, BP2)
            RPcomb = mag_combine(RP1, RP2)
            BPRPcomb = BPcomb - RPcomb

            dist = np.sqrt((isoch[0] - Gcomb)**2 + (isoch[3] - BPRPcomb)**2)
            idx = np.argmin(dist)
            br_dist.append(dist[idx])

            cmd_plot_binar.append([BPRPcomb, Gcomb])

        # plt.plot(q_vals, br_dist, label="{:.2f}".format(Gmag1))
        br_dist_all.append(br_dist)

    plt.subplot(121)
    plt.scatter(*np.array(cmd_plot).T, c='k', marker='o', zorder=5)
    plt.scatter(*np.array(cmd_plot_binar).T, c='r', marker='x', zorder=3)
    plt.scatter(isoch[3], isoch[0], marker='.', c='g', s=2, zorder=0)
    # plt.gca().invert_yaxis()
    plt.minorticks_on()
    plt.xlim(-0.2, 3)
    plt.ylim(18.7, 6.1)
    plt.grid(alpha=.5)
    plt.xlabel("BP-RP")
    plt.ylabel("G")

    plt.subplot(122)
    plt.xlabel("q (m2/m1)")
    plt.ylabel("CMD dist")
    Gmags = np.array(cmd_plot).T[1]
    for i, br_dist in enumerate(br_dist_all):
        plt.plot(q_vals, br_dist, label="{:.2f}".format(Gmags[i]))
    plt.axhline(0.02, ls=':', c='r')
    plt.minorticks_on()
    plt.grid(alpha=.5)
    plt.legend()
    plt.show()


def interp(isoch, N=5000):
    interp_data = []
    for fce in isoch:
        t, xp = np.linspace(0., 1., N), np.linspace(0, 1, len(fce))
        interp_data.append(np.interp(t, xp, fce))
    return (np.array(interp_data))


def mag_combine(m1, m2):
    """
    Combine two magnitudes. This is a faster re-ordering of the standard
    formula:

    -2.5 * np.log10(10 ** (-0.4 * m1) + 10 ** (-0.4 * m2))

    """

    # 10**-.4 = 0.398107
    mbin = -2.5 * (-.4 * m1 + np.log10(1. + 0.398107 ** (m2 - m1)))

    return mbin


if __name__ == '__main__':
    Gmag = np.array([21.79064696, 21.65164696, 21.59164696, 21.54464696, 21.30064696,
       21.16564696, 21.06464696, 20.76464696, 20.73964696, 20.44164696,
       20.29064696, 19.91364696, 19.42764696, 19.03164696, 18.83464696,
       18.68964696, 18.36164696, 18.18764696, 17.92764696, 17.66764696,
       17.65164696, 17.64164696, 17.46164696, 17.35664696, 17.18864696,
       16.98964696, 16.63064696, 16.55664696, 16.15464696, 16.00164696,
       15.87664696, 15.54964696, 15.47664696, 15.17464696, 14.97464696,
       14.84064696, 14.68564696, 14.52364696, 14.51064696, 14.31464696,
       14.19564696, 13.90764696, 13.62564696, 13.36264696, 13.11164696,
       13.02264696, 12.87664696, 12.83964696, 12.68564696, 12.58764696,
       12.55664696, 12.43664696, 12.23264696, 12.04064696, 11.85964696,
       11.69164696, 11.53364696, 11.38264696, 11.23864696, 11.10264696,
       11.03864696, 10.97564696, 10.91464696, 10.85664696, 10.79864696,
       10.74464696, 10.69164696, 10.64064696, 10.59164696, 10.54464696,
       10.49764696, 10.45264696, 10.36564696, 10.28364696, 10.20464696,
       10.13064696, 10.05864696, 10.05464696,  9.98864696,  9.91964696,
        9.78964696,  9.54764696,  9.54364696,  9.38064696,  9.31264696,
        9.21964696,  9.09564696,  9.01164696,  8.88964696,  8.84264696,
        8.68964696,  8.60064696,  8.49664696,  8.48164696,  8.30564696,
        8.27564696,  8.11464696,  8.05764696,  7.92164696,  7.91264696,
        7.79064696,  7.71964696,  7.60464696,  7.50764696,  7.42964696,
        7.33064696,  7.27164696,  7.23464696,  7.10264696,  7.00864696,
        6.96864696,  6.85264696,  6.70964696,  6.69164696,  6.61364696,
        6.47964696,  6.34864696,  6.28264696,  6.19564696,  6.11464696,
        6.09964696,  6.10964696,  6.13664696,  6.16064696,  6.17864696,
        6.18564696,  6.19064696,  6.21064696,  6.21664696,  6.19764696,
        6.14064696,  6.05464696,  5.95664696,  5.86164696,  5.77464696,
        5.69564696,  5.62164696,  5.55364696,  5.48964696,  5.42964696,
        5.37364696,  5.32064696,  5.27064696,  5.22364696,  5.17864696,
        5.13764696,  5.09964696,  5.06464696,  5.03464696,  5.00964696,
        4.99064696,  4.98064696,  4.97664696,  4.97764696,  4.98364696,
        4.99464696,  5.00864696,  5.02564696,  5.04564696,  5.06864696,
        5.09464696,  5.12264696,  5.15264696,  5.18564696,  5.22164696,
        5.26064696,  5.30464696,  5.35664696,  5.41764696,  5.50064696,
        5.58964696,  5.68064696,  5.75864696,  5.78064696,  5.78064696,
        5.74464696,  5.69264696,  5.62064696,  5.54964696,  5.46664696,
        5.45164696,  5.42764696,  5.38164696,  5.37164696,  5.27964696,
        5.19664696,  5.11964696,  5.03964696,  4.95864696,  4.87964696,
        4.81764696,  4.77664696,  4.73364696,  4.76864696,  4.82364696,
        4.88664696,  4.94764696,  5.00664696,  5.06564696,  5.13464696,
        5.20964696,  5.28064696,  5.35464696,  5.39164696,  5.40564696,
        5.33864696,  5.31764696,  5.30664696,  5.19964696,  5.08064696,
        4.98264696,  4.90164696,  4.84264696,  4.79664696,  4.75564696,
        4.71564696,  4.67864696,  4.64764696,  4.61264696,  4.59264696,
        4.59364696,  4.60064696,  4.53864696,  4.54164696,  4.53864696,
        4.55764696,  4.58864696,  4.63464696,  4.68764696,  4.74764696,
        4.84064696,  4.92664696,  5.00764696,  5.08464696,  5.05764696,
        4.99764696,  4.96764696,  4.94764696,  4.92064696,  4.91064696,
        4.86164696,  4.79964696,  4.72964696,  4.66064696,  4.59564696,
        4.52964696,  4.46364696,  4.40464696,  4.34764696,  4.29264696,
        4.24264696,  4.20264696,  4.16364696,  4.12464696,  4.09164696,
        4.04764696,  4.01464696,  3.98264696,  3.97364696,  3.97764696,
        3.98364696,  4.01564696,  4.06664696,  4.10964696,  4.08764696,
        4.04964696,  4.02864696,  4.01264696,  4.01364696,  4.02364696,
        4.05664696,  4.07164696,  4.07564696])
    BPmag = np.array([24.37837118, 24.24037118, 24.18137118, 24.13437118, 23.83337118,
       23.63237118, 23.48537118, 23.07337118, 23.04037118, 22.63637118,
       22.42437118, 21.89537118, 21.23437118, 20.71237118, 20.45937118,
       20.27637118, 19.86237118, 19.64537118, 19.31937118, 18.99537118,
       18.97537118, 18.96237118, 18.73437118, 18.60537118, 18.39437118,
       18.14637118, 17.74237118, 17.62437118, 17.03737118, 16.84137118,
       16.68337118, 16.27637118, 16.18537118, 15.82637118, 15.59637118,
       15.44337118, 15.26737118, 15.08637118, 15.07037118, 14.85237118,
       14.71837118, 14.39737118, 14.08537118, 13.79737118, 13.52237118,
       13.42637118, 13.26737118, 13.22737118, 13.06237118, 12.95537118,
       12.92137118, 12.79137118, 12.57137118, 12.36337118, 12.16737118,
       11.98437118, 11.80937118, 11.63937118, 11.47737118, 11.32337118,
       11.25037118, 11.17937118, 11.10937118, 11.04437118, 10.97837118,
       10.91737118, 10.85837118, 10.80037118, 10.74637118, 10.69437118,
       10.64237118, 10.59337118, 10.49837118, 10.41037118, 10.32537118,
       10.24537118, 10.16837118, 10.16437118, 10.09437118, 10.02237118,
        9.88437118,  9.63237118,  9.62937118,  9.46037118,  9.38937118,
        9.29337118,  9.16637118,  9.07937118,  8.95437118,  8.90537118,
        8.74937118,  8.65837118,  8.55137118,  8.53637118,  8.35637118,
        8.32637118,  8.16237118,  8.10337118,  7.96537118,  7.95637118,
        7.83237118,  7.76037118,  7.64437118,  7.54637118,  7.46837118,
        7.36937118,  7.31037118,  7.27337118,  7.14037118,  7.04737118,
        7.00837118,  6.89237118,  6.75037118,  6.73237118,  6.65537118,
        6.52337118,  6.39537118,  6.33037118,  6.24637118,  6.16537118,
        6.14937118,  6.15637118,  6.17937118,  6.20037118,  6.21537118,
        6.21937118,  6.22437118,  6.24637118,  6.25437118,  6.23737118,
        6.18437118,  6.10137118,  6.00737118,  5.91637118,  5.83237118,
        5.75637118,  5.68737118,  5.62337118,  5.56337118,  5.50737118,
        5.45537118,  5.40637118,  5.36037118,  5.31837118,  5.27837118,
        5.24237118,  5.21037118,  5.18137118,  5.15937118,  5.14137118,
        5.13537118,  5.13637118,  5.14637118,  5.16337118,  5.18837118,
        5.21937118,  5.25537118,  5.29537118,  5.33837118,  5.38537118,
        5.43637118,  5.48937118,  5.54637118,  5.60637118,  5.67037118,
        5.73837118,  5.81037118,  5.89137118,  5.98137118,  6.09137118,
        6.20537118,  6.31837118,  6.42037118,  6.45037118,  6.46737118,
        6.45637118,  6.42137118,  6.36737118,  6.31437118,  6.24937118,
        6.23837118,  6.21937118,  6.18337118,  6.17537118,  6.10637118,
        6.04337118,  5.98437118,  5.92337118,  5.86137118,  5.80137118,
        5.75537118,  5.72737118,  5.69837118,  5.71837118,  5.75237118,
        5.79637118,  5.84137118,  5.88537118,  5.92737118,  5.98037118,
        6.03737118,  6.09037118,  6.14337118,  6.15837118,  6.15537118,
        6.07037118,  6.04537118,  6.03137118,  5.90337118,  5.75937118,
        5.63737118,  5.52837118,  5.43937118,  5.36637118,  5.29937118,
        5.22937118,  5.16237118,  5.10437118,  5.03737118,  5.00137118,
        5.01537118,  5.04137118,  5.00137118,  5.02937118,  5.03537118,
        5.07937118,  5.14237118,  5.22737118,  5.31537118,  5.40537118,
        5.53237118,  5.64537118,  5.75137118,  5.86837118,  5.87537118,
        5.83937118,  5.81837118,  5.80437118,  5.78237118,  5.77837118,
        5.74437118,  5.70137118,  5.65137118,  5.60537118,  5.56537118,
        5.52437118,  5.48437118,  5.45737118,  5.43737118,  5.41737118,
        5.40337118,  5.41737118,  5.43237118,  5.45037118,  5.49037118,
        5.53037118,  5.55137118,  5.59937118,  5.70237118,  5.83537118,
        5.98437118,  6.16437118,  6.38337118,  6.55837118,  6.47037118,
        6.31237118,  6.22537118,  6.15737118,  6.15837118,  6.20537118,
        6.34837118,  6.41137118,  6.42537118])
    RPmag = np.array([20.26970286, 20.13070286, 20.07070286, 20.02370286, 19.79070286,
       19.66770286, 19.57570286, 19.30070286, 19.27770286, 19.00370286,
       18.86570286, 18.52470286, 18.08170286, 17.72170286, 17.54070286,
       17.40770286, 17.10770286, 16.94870286, 16.71270286, 16.47870286,
       16.46470286, 16.45570286, 16.29570286, 16.20270286, 16.05170286,
       15.87770286, 15.53870286, 15.48770286, 15.19170286, 15.06870286,
       14.96670286, 14.70070286, 14.64070286, 14.38470286, 14.20970286,
       14.09070286, 13.95470286, 13.81170286, 13.79970286, 13.62670286,
       13.52170286, 13.26570286, 13.01270286, 12.77770286, 12.55270286,
       12.47270286, 12.34070286, 12.30670286, 12.16570286, 12.07870286,
       12.05270286, 11.94370286, 11.76170286, 11.59070286, 11.43070286,
       11.28570286, 11.15170286, 11.02870286, 10.91570286, 10.81170286,
       10.76170286, 10.71370286, 10.66670286, 10.62270286, 10.57870286,
       10.53670286, 10.49670286, 10.45670286, 10.41770286, 10.38070286,
       10.34270286, 10.30670286, 10.23470286, 10.16570286, 10.09870286,
       10.03370286,  9.97070286,  9.96670286,  9.90870286,  9.84770286,
        9.72870286,  9.50570286,  9.50170286,  9.35070286,  9.28670286,
        9.19770286,  9.08070286,  9.00170286,  8.88470286,  8.83970286,
        8.69470286,  8.60970286,  8.50970286,  8.49570286,  8.32470286,
        8.29670286,  8.14170286,  8.08570286,  7.95370286,  7.94570286,
        7.82570286,  7.75670286,  7.64270286,  7.54770286,  7.47070286,
        7.37170286,  7.31370286,  7.27670286,  7.14370286,  7.04870286,
        7.00970286,  6.89070286,  6.74470286,  6.72670286,  6.64670286,
        6.50770286,  6.37270286,  6.30370286,  6.21370286,  6.13070286,
        6.11770286,  6.13470286,  6.16770286,  6.19770286,  6.22270286,
        6.23470286,  6.24170286,  6.25870286,  6.25970286,  6.23470286,
        6.17170286,  6.07870286,  5.97370286,  5.87170286,  5.77670286,
        5.69070286,  5.60970286,  5.53470286,  5.46270286,  5.39570286,
        5.33070286,  5.26970286,  5.21170286,  5.15570286,  5.10170286,
        5.05070286,  5.00170286,  4.95470286,  4.91070286,  4.86970286,
        4.83170286,  4.79770286,  4.76870286,  4.74170286,  4.71670286,
        4.69270286,  4.67170286,  4.65370286,  4.64070286,  4.62970286,
        4.62170286,  4.61670286,  4.61570286,  4.61770286,  4.62370286,
        4.63270286,  4.64870286,  4.67270286,  4.70670286,  4.76370286,
        4.83370286,  4.90570286,  4.96370286,  4.97970286,  4.96570286,
        4.90970286,  4.84470286,  4.75970286,  4.67670286,  4.57970286,
        4.56270286,  4.53470286,  4.48170286,  4.46970286,  4.36270286,
        4.26670286,  4.17670286,  4.08470286,  3.99170286,  3.90170286,
        3.83070286,  3.78170286,  3.72970286,  3.77370286,  3.84170286,
        3.91570286,  3.98670286,  4.05670286,  4.12470286,  4.20470286,
        4.29170286,  4.37470286,  4.46270286,  4.51770286,  4.54270286,
        4.48870286,  4.47270286,  4.46370286,  4.37170286,  4.27270286,
        4.19570286,  4.13770286,  4.10370286,  4.08070286,  4.06470286,
        4.05170286,  4.04370286,  4.04170286,  4.04070286,  4.03970286,
        4.02670286,  4.01070286,  3.92670286,  3.90270286,  3.89170286,
        3.88670286,  3.88770286,  3.89870286,  3.92270286,  3.95770286,
        4.02170286,  4.08870286,  4.15070286,  4.19770286,  4.14670286,
        4.07070286,  4.03370286,  4.01070286,  3.97970286,  3.96670286,
        3.90770286,  3.83470286,  3.75170286,  3.66970286,  3.58970286,
        3.50870286,  3.42870286,  3.35170286,  3.27670286,  3.20370286,
        3.13470286,  3.07270286,  3.00970286,  2.94870286,  2.88970286,
        2.81670286,  2.76670286,  2.70970286,  2.67070286,  2.64070286,
        2.61270286,  2.61270286,  2.63070286,  2.64870286,  2.63970286,
        2.62370286,  2.61670286,  2.61170286,  2.61170286,  2.61470286,
        2.62670286,  2.63170286,  2.63370286])
    mini = np.array([0.09      , 0.09690742, 0.09999999, 0.10275242, 0.11452654,
       0.12      , 0.12486545, 0.14      , 0.14144297, 0.16      ,
       0.17054993, 0.19999999, 0.25      , 0.30000001, 0.32784393,
       0.34999999, 0.40000004, 0.4244206 , 0.46104956, 0.49748731,
       0.5       , 0.50138628, 0.52278924, 0.53345424, 0.55000001,
       0.56704998, 0.60000002, 0.60372734, 0.62715363, 0.63864744,
       0.64999998, 0.68470383, 0.69999999, 0.75      , 0.77936274,
       0.79910719, 0.82244253, 0.84617662, 0.84821439, 0.87827659,
       0.89732158, 0.94642872, 0.99553597, 1.04464316, 1.09375036,
       1.11186373, 1.14285755, 1.15210962, 1.19196475, 1.2085762 ,
       1.21317244, 1.24107194, 1.29017901, 1.33928633, 1.3883934 ,
       1.4375006 , 1.48660791, 1.5357151 , 1.58482218, 1.63392937,
       1.65848303, 1.68303657, 1.7075901 , 1.73214376, 1.7566973 ,
       1.78125083, 1.80580461, 1.83035827, 1.85491169, 1.87946534,
       1.90401888, 1.92914772, 1.97940516, 2.02966237, 2.07992005,
       2.1301775 , 2.18043494, 2.183393  , 2.23069239, 2.28094959,
       2.38146472, 2.57947874, 2.5824945 , 2.72276568, 2.78352404,
       2.86920667, 2.98455405, 3.06544399, 3.18558359, 3.23260427,
       3.38661337, 3.47864485, 3.58764315, 3.60288882, 3.78867292,
       3.8199451 , 3.9897027 , 4.05119133, 4.19073248, 4.19973183,
       4.32174969, 4.39176226, 4.50293255, 4.59279156, 4.66183186,
       4.74615288, 4.79382181, 4.82450438, 4.92816448, 4.99485159,
       5.02251244, 5.09931564, 5.18583441, 5.19588137, 5.23906994,
       5.30666447, 5.36855221, 5.39691114, 5.43248892, 5.46971512,
       5.48333597, 5.4976635 , 5.50216293, 5.50422716, 5.50537109,
       5.50599003, 5.5062604 , 5.50647879, 5.50665808, 5.50681162,
       5.50700331, 5.50720406, 5.50741768, 5.50764036, 5.50786829,
       5.50809908, 5.50833035, 5.5085597 , 5.5087862 , 5.5090065 ,
       5.5092206 , 5.50942755, 5.50962591, 5.50981617, 5.50999832,
       5.51017141, 5.5103364 , 5.51049376, 5.51064301, 5.51078558,
       5.51092005, 5.51104784, 5.511168  , 5.51128244, 5.51139069,
       5.51149273, 5.51158953, 5.51168156, 5.51176882, 5.51185131,
       5.51193047, 5.51200533, 5.51207638, 5.51214361, 5.51220798,
       5.51226997, 5.51233196, 5.51239872, 5.51247311, 5.51257944,
       5.51269674, 5.51282167, 5.51296091, 5.51300669, 5.51309729,
       5.51322412, 5.51330137, 5.51338291, 5.51346016, 5.5135622 ,
       5.51358271, 5.51362514, 5.51371098, 5.51374197, 5.51411724,
       5.51457882, 5.51504755, 5.51555538, 5.51606274, 5.51657057,
       5.51704884, 5.51776505, 5.51890183, 5.52408314, 5.53044224,
       5.53530216, 5.53919458, 5.54263687, 5.54594469, 5.54977179,
       5.55437088, 5.55974054, 5.56732035, 5.57872629, 5.58721399,
       5.59547281, 5.59794044, 5.59928894, 5.60373116, 5.60669184,
       5.60865402, 5.61010933, 5.61107159, 5.61190367, 5.61272144,
       5.61368704, 5.61484861, 5.61620188, 5.61880779, 5.62202644,
       5.62788153, 5.6341095 , 5.67003155, 5.68043804, 5.68617344,
       5.69117308, 5.6970253 , 5.70315552, 5.70890474, 5.71301556,
       5.71865034, 5.72303152, 5.72726679, 5.73825264, 5.7449789 ,
       5.74647379, 5.74674273, 5.74684811, 5.74725294, 5.74809551,
       5.74857807, 5.74897385, 5.74945068, 5.75003147, 5.75071812,
       5.75150776, 5.7523942 , 5.75334644, 5.75427723, 5.7550993 ,
       5.75581598, 5.75646305, 5.75706339, 5.7576251 , 5.75822973,
       5.75889349, 5.75919533, 5.75942802, 5.75962973, 5.75981474,
       5.75999117, 5.76015234, 5.76032686, 5.76054335, 5.76078415,
       5.76081419, 5.76082754, 5.76083851, 5.76085758, 5.76087809,
       5.76096106, 5.76098776, 5.76099396])
    main(Gmag, BPmag, RPmag, mini)
